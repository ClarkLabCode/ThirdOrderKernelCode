function runDetails = RunMultipleStimuli(varargin)
% Run one or more parameter files. Options are: 
% 'useDLPs' (boolean)
% 'genotype' (string)
% 'condstr' (string) Any special conditions to log about the run
% 'paramFiles' (string or cell array of strings) The path(s) to the parameter files
%                                                you want to run. Either absolute or
%                                                relative to the paramFiles folder.
% 'stimDuration' (numeric or cell array of numeric) Duration(s) of the parameter
%													file(s) in frames
% 'probeDuration' (numeric or cell array of numeric) Duration(s) of the probe
%													 stimuli in frames 
useDLPs = [];
genotype = '';
condstr = '';
paramFile = cell(0,1);
probeFile = cell(0,1);
incubationTime = 0;
databaseInfo = [];
sameFly = 0;

probeParameters = cell(0,1);

stimDuration = cell(0,1);
probeDuration = cell(0,1);
runDetails = [];

rootFolder = fileparts(which('RunStimulus'));
paramPath = fullfile(rootFolder, 'paramfiles');

% load default values and allow the values in sysConfig to overwrite
% them
sysConfig = GetSystemConfiguration();

%% input varargin with the form ('variableName',variableValue,...)
for ii = 1:2:length(varargin)
    eval([varargin{ii} '= varargin{' num2str(ii+1) '};']);
end

%% randomize seed
seedState = rng('shuffle');

if isempty(runDetails)
    %% use the DLPs?
    if isempty(useDLPs)
        useDLPs = UiChooseScreen;
    end
    
    %% assign flyId
    flyId = AssignFlyId(sameFly);
    
    %% get genotype and any pre comments
    if isempty(genotype)
        switch sysConfig.genoEnter
            case 0
                [genotype,condstr,sameFly] = UiGetPreComments;
            case 1
                if ~isempty(databaseInfo)
                    databaseInfo = rmfield(databaseInfo, {'cylinderRotation', 'flyHeight'});
                end
                [databaseInfo] = UiGetPreCommentsSurgery(databaseInfo);
                genotype = databaseInfo.genotype;
                condstr = databaseInfo.comments;
                databaseInfo.cylinderRotation = sysConfig.flyHeadAngle;
                databaseInfo.flyHeight = sysConfig.flyHeight;
                databaseInfo.flyId = flyId;
                sameFly = databaseInfo.sameFly;
        end
    end
    
    %% Check for laser
    % We only want to run all the twoPhoton connection parameters if we're
    % not doing a test run of the stimulus. The 'tester' genotype choice
    % that'll allow testing of the connection without gathering data.
    sysConfig.twoPhoton = logical(sysConfig.twoPhoton);
    if any(strcmp(genotype, {'test', 'xtplot'}))
        sysConfig.twoPhoton = false;
        sysConfig.useProbe = 0;
    elseif strcmp(genotype, 'tester') && sysConfig.twoPhoton
        % We switch it back to test here so it doesn't interfere with
        genotype = 'test';
        databaseInfo.genotype = genotype;
        databaseInfo.cellType = 'test';
        databaseInfo.fluorescentProtein = 'test';
        databaseInfo.surgeon = 'test';
        databaseInfo.condition = 'test';
        databaseInfo.eye = 'test';
        databaseInfo.comments = 'test';
        databaseInfo.perfusion = true;
        databaseInfo.cylinderRotation = 'test';
        databaseInfo.flyHeight = 'test';
        databaseInfo.flyId = 'test';
    end
    
    %% get the parameter files
    if isempty(paramFile);
        paramFile = UiPickFiles('filterSpec',paramPath,'Prompt','Select parameter files to run');
    else
        if ~iscell(paramFile)
            paramFile = {paramFile};
        end
        
        for pa = 1:length(paramFile)
            if isempty(regexp(paramFile{pa}(1:3),'[A-z]\:\\','once'))
                paramFile{pa} = fullfile(paramPath,paramFile{pa});
            end
        end
    end
    
    stimulusParameters = GetParamsFromPaths(paramFile);
    
    %% ask for duration of the stimulus
    if isempty(stimDuration)
        for pa = 1:length(stimulusParameters)
            stimDuration{pa} = sysConfig.stimDuration; % default stim duration
            
            if isfield(stimulusParameters{pa},'totalTime');
                stimDuration{pa} = stimulusParameters{pa}.totalTime;
            else
                if sysConfig.forceDuration==1
                    [~,probeName] = fileparts(paramFile{pa});
                    answer = inputdlg(['For how many seconds do you want to present ' probeName '?'],probeName,[1 80]);
                    
                    % Multiply by 60 for 60 frames/second that the projector
                    % outputs--check out RunStimulus to see how this works
                    stimDuration{pa} = str2double(answer{1})*60;
                    stimulusParameters{pa}(1).totalTime = stimDuration{pa};
                end
            end
        end
    end
    
    %% get probe parameter file
    if sysConfig.useProbe
        if isempty(probeFile);
            probeFile = UiPickFiles('filterSpec',paramPath,'Prompt','Select probe parameter files to run');
            % Allows you to pick just one probe file to apply to all
            % stimulus files
            if length(probeFile) == 1
                probeFile = repmat(probeFile, 1, length(paramFile));
            end
        else
            if ~iscell(probeFile)
                probeFile = repmat({probeFile}, 1, length(paramFile));
            end
            
            for pa = 1:length(probeFile)
                if isempty(regexp(probeFile{pa}(1:3),'[A-z]\:\\','once'))
                    probeFile{pa} = fullfile(paramPath,probeFile{pa});
                end
            end
        end
        
        probeParameters = GetParamsFromPaths(probeFile);
        
        if isempty(probeDuration)
            % ask for duration of the probe
            for pa = 1:length(probeParameters)
                probeDuration{pa} = sysConfig.probeDuration; % default stim duration
                
                if isfield(probeParameters{pa},'totalTime');
                    probeDuration{pa} = probeParameters{pa}.totalTime;
                else
                    if sysConfig.forceDuration
                        [~,probeName] = fileparts(probeFile{pa});
                        answer = inputdlg(['For how many seconds do you want to present ' probeName '?'],probeName,[1 80]);
                        
                        % Multiply by 60 for 60 frames/second that the projector
                        % outputs--check out master_stimulus to see how this works
                        probeDuration{pa} = str2double(answer{1})*60;
                    end
                end
            end
        end
    end
    
    %% set up output
    runDetails.sysConfig = sysConfig;
    
    runDetails.useDLPs = useDLPs;
    runDetails.genotype = genotype;
    runDetails.condstr = condstr;
    
    runDetails.stimulusParameters = stimulusParameters;
    runDetails.paramFiles = paramFile;
    runDetails.stimDuration = stimDuration;
    
    runDetails.probeParameters = probeParameters;
    runDetails.probeFiles = probeFile;
    runDetails.probeDuration = probeDuration;
    if sysConfig.twoPhoton
        runDetails.databaseInfo = databaseInfo;
    end
else
    sysConfig = runDetails.sysConfig;
    
    useDLPs = runDetails.useDLPs;
    genotype = runDetails.genotype;
    condstr = runDetails.condstr;
    
    stimulusParameters = runDetails.stimulusParameters;
    paramFile = runDetails.paramFiles;
    stimDuration = runDetails.stimDuration;
    
    probeParameters = runDetails.probeParameters;
    probeFile = runDetails.probeFiles;
    probeDuration = runDetails.probeDuration;
end
<<<<<<< HEAD
    statusHandles = makeStatusGui();
    statusHandles.progressBarMulti.setMaximum(length(paramFile)*2);
    closeFigure = onCleanup(@() close(statusHandles.statusGui));
=======

>>>>>>> master

%% run the stimulus
    if sysConfig.twoPhoton
        connectionToTwoPhoton = OpenTCPIPConnectionToTwoPhoton;
    end
    
    for pp = 1:length(paramFile)
        statusHandles.progressBarMulti.setValue(2*(pp-1)+1);
        progressString = ['Running parameter file ' num2str(pp) ' of ' num2str(length(paramFile))];
        statusHandles.progressBarMulti.setString(progressString);
        if length(probeParameters)==1
            ppProbe = 1;
        else
            ppProbe = pp;
        end
        if sysConfig.useProbe
            if sysConfig.twoPhoton
                probeParameters{ppProbe}(1).totalTime = probeDuration{ppProbe};
                stimulusParameters{pp}(1).totalTime = stimDuration{pp};
                stimulusParameters{pp} = MergeParameterFiles(probeParameters{ppProbe}, stimulusParameters{pp});
                
                stimDuration{pp} = stimulusParameters{pp}(1).totalTime;
            else
<<<<<<< HEAD
                Q=SetupStimulus(sysConfig,pp,useDLPs,genotype,condstr,probeParameters{ppProbe},probeFile{ppProbe},probeDuration{ppProbe},incubationTime);
                Q.statusHandles = statusHandles;
                PrintMultiStatus(pp,length(paramFile));
=======
                Q=SetupStimulus(sysConfig,pp,useDLPs,genotype,condstr,probeParameters{ppProbe},probeFile{ppProbe},probeDuration{ppProbe},incubationTime,flyId);
>>>>>>> master
                RunStimulus(Q);
            end
        end
        if sysConfig.twoPhoton
            flyId = SaveDatabaseValues(connectionToTwoPhoton, paramFile{pp}, databaseInfo);
        end
        Q=SetupStimulus(sysConfig,pp,useDLPs,genotype,condstr,stimulusParameters{pp},paramFile{pp},stimDuration{pp},incubationTime,flyId);
        if sysConfig.twoPhoton
            if sysConfig.useProbe
                Q.paths.probePath = probeFile{ppProbe};
            else
                Q.paths.probePath = '';
            end
            SendAcquisitionInitiationMessage(connectionToTwoPhoton, Q);
        end
        Q.statusHandles = statusHandles;
        PrintMultiStatus(pp,length(paramFile));
        RunStimulus(Q);
        if sysConfig.twoPhoton
            TransferBehaviorData(connectionToTwoPhoton, Q);
        end
    end
    
    if sysConfig.twoPhoton
        CloseTCPIPConnectionToTwoPhoton(connectionToTwoPhoton);
    end
    
%    SendNotification(Q);
end